name: Deploy to Staging with Performance Check

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      theme_id:
        description: 'Staging Theme ID'
        required: false

jobs:
  deploy-staging:
    name: Deploy to Shopify Staging
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Lint Liquid templates
        run: npx shopify theme check --fail-level info
        continue-on-error: true

      - name: Validate CSS files
        run: |
          echo "Validating CSS files for Shopify compatibility..."
          
          # Check CSS files exist in assets directory
          if [ ! -f "assets/custom-styles.css" ]; then
            echo "‚ùå Error: assets/custom-styles.css not found"
            exit 1
          fi
          
          # Check for Liquid syntax in CSS (should use CSS variables instead)
          if grep -r "{{" assets/*.css 2>/dev/null; then
            echo "‚ö†Ô∏è  Warning: Liquid syntax found in CSS files. Use CSS variables in theme.liquid instead."
          fi
          
          # Verify CSS file paths are correct (no subdirectories)
          if find assets -type d -mindepth 1 | grep -q .; then
            echo "‚ö†Ô∏è  Warning: Subdirectories found in assets/. CSS files should be in assets/ root only."
            if find assets -type f -name "*.css" ! -path "assets/*.css"; then
              echo "‚ùå Error: CSS files in subdirectories detected. Move to assets/ root."
              exit 1
            fi
          fi
          
          # Check CSS file sizes
          for css_file in assets/*.css; do
            if [ -f "$css_file" ]; then
              size=$(wc -c < "$css_file")
              if [ $size -gt 102400 ]; then
                echo "‚ö†Ô∏è  Warning: $css_file is larger than 100KB ($size bytes). Consider splitting."
              fi
              echo "‚úÖ $css_file: $size bytes"
            fi
          done
          
          echo "CSS validation complete!"
        continue-on-error: true

      - name: Install Shopify CLI globally
        run: npm install -g @shopify/cli

      - name: Deploy to Staging Theme
        env:
          SHOPIFY_CLI_THEME_TOKEN: ${{ secrets.SHOPIFY_THEME_TOKEN }}
          SHOPIFY_STORE: 1commercesolutions.shop
          SHOPIFY_STAGING_THEME_ID: ${{ secrets.SHOPIFY_STAGING_THEME_ID }}
        run: |
          shopify theme push \
            --to "$SHOPIFY_STAGING_THEME_ID" \
            --store "$SHOPIFY_STORE" \
            --allow-live \
            --force

      - name: Run smoke tests
        run: |
          echo "Running basic theme validation..."
          curl -s "https://1commercesolutions.shop/cdn/shop/t/${{ secrets.SHOPIFY_STAGING_THEME_ID }}/assets/custom-styles.css" | head -c 100
        continue-on-error: true

      # NEW: Lighthouse CI Performance Check
      - name: Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v10
        with:
          urls: |
            https://1commercesolutions.shop/?preview_theme_id=${{ secrets.SHOPIFY_STAGING_THEME_ID }}
          uploadArtifacts: true
          temporaryPublicStorage: true
        continue-on-error: true

      - name: Create deployment annotation
        if: always()
        run: |
          echo "‚úÖ Deployment to staging: ${{ job.status }}"
          echo "Theme ID: ${{ secrets.SHOPIFY_STAGING_THEME_ID }}"
          echo "Store: 1commercesolutions.shop"
          echo "Branch: develop"
          echo "Lighthouse reports uploaded to temporary public storage"

      - name: Post deployment status to PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚úÖ Deployed to staging theme. Preview: https://1commercesolutions.shop\\n\\nüìä Lighthouse CI reports available in the workflow logs.'
            })
        continue-on-error: true
