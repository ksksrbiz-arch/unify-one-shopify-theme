name: Deploy to Staging with Performance Check

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      theme_id:
        description: 'Staging Theme ID'
        required: false

jobs:
  deploy-staging:
    name: Deploy to Shopify Staging
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Lint Liquid templates
        run: npx shopify theme check --fail-level info
        continue-on-error: true

      - name: Install Shopify CLI
        run: npm install -g @shopify/cli @shopify/theme

      - name: Deploy to Staging Theme
        env:
          SHOPIFY_CLI_THEME_TOKEN: ${{ secrets.SHOPIFY_THEME_TOKEN }}
          SHOPIFY_STORE: 1commerce.shop
          SHOPIFY_STAGING_THEME_ID: ${{ secrets.SHOPIFY_STAGING_THEME_ID }}
        run: |
          shopify theme push \
            --to "$SHOPIFY_STAGING_THEME_ID" \
            --store "$SHOPIFY_STORE" \
            --allow-live \
            --force

      - name: Run smoke tests
        run: |
          echo "Running basic theme validation..."
          curl -s "https://1commerce.shop/cdn/shop/t/${{ secrets.SHOPIFY_STAGING_THEME_ID }}/assets/custom-styles.css" | head -c 100
        continue-on-error: true

      # NEW: Lighthouse CI Performance Check
      - name: Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v10
        with:
          urls: |
            https://1commerce.shop/?preview_theme_id=${{ secrets.SHOPIFY_STAGING_THEME_ID }}
          uploadArtifacts: true
          temporaryPublicStorage: true
        continue-on-error: true

      - name: Create deployment annotation
        if: always()
        run: |
          echo "âœ… Deployment to staging: ${{ job.status }}"
          echo "Theme ID: ${{ secrets.SHOPIFY_STAGING_THEME_ID }}"
          echo "Store: 1commerce.shop"
          echo "Branch: develop"
          echo "Lighthouse reports uploaded to temporary public storage"

      - name: Post deployment status to PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âœ… Deployed to staging theme. Preview: https://1commerce.shop\\n\\nðŸ“Š Lighthouse CI reports available in the workflow logs.'
            })
        continue-on-error: true
