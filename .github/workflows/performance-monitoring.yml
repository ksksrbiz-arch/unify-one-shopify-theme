name: Deploy to Staging with Lighthouse CI Performance Check

on:
  push:
    branches: [main]
    paths-ignore:
      - '*.md'
      - '.github/workflows/performance-monitoring.yml'

jobs:
  deploy-staging:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: npm ci
      
      # Validate theme files
      - name: Run Liquid linter
        run: npm run lint:liquid
        continue-on-error: true
      
      - name: Validate CSS/JS
        run: npm run lint
        continue-on-error: true
      
      # Deploy to staging theme
      - name: Deploy to Staging Theme
        run: |
          npm install -g @shopify/cli
          shopify theme push --store=${{ secrets.SHOPIFY_STORE_NAME }} --theme=${{ secrets.SHOPIFY_STAGING_THEME_ID }}
        env:
          SHOPIFY_CLI_THEME_TOKEN: ${{ secrets.SHOPIFY_THEME_TOKEN }}
      
      # Run Lighthouse CI for performance benchmarking
      - name: Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v10
        with:
          urls: |
            https://${{ secrets.SHOPIFY_STORE_NAME }}/?preview_theme_id=${{ secrets.SHOPIFY_STAGING_THEME_ID }}
            https://${{ secrets.SHOPIFY_STORE_NAME }}/products/example-product?preview_theme_id=${{ secrets.SHOPIFY_STAGING_THEME_ID }}
            https://${{ secrets.SHOPIFY_STORE_NAME }}/collections/all?preview_theme_id=${{ secrets.SHOPIFY_STAGING_THEME_ID }}
          uploadArtifacts: true
          temporaryPublicStorage: true
          configPath: './lighthouserc.json'
      
      # Check if performance metrics meet budget
      - name: Verify Performance Budget
        run: npm run lighthouse:check
        continue-on-error: true
      
      # Post results to PR
      - name: Comment Performance Results on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const reports = fs.existsSync('./.lighthouseci/reports.json') 
              ? JSON.parse(fs.readFileSync('./.lighthouseci/reports.json', 'utf8'))
              : [];
            
            if (reports.length > 0) {
              const latest = reports[reports.length - 1];
              const metrics = latest.categories || {};
              
              let comment = '## âš¡ Lighthouse Performance Report\\n\\n';
              comment += '| Metric | Score |\\n';
              comment += '|--------|-------|\\n';
              Object.entries(metrics).forEach(([key, value]) => {
                const score = Math.round(value.score * 100);
                const icon = score >= 90 ? 'ðŸŸ¢' : score >= 50 ? 'ðŸŸ¡' : 'ðŸ”´';
                comment += `| ${icon} ${key} | ${score} |\\n`;
              });
              
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }
      
      # Notify Slack of deployment
      - name: Notify Slack
        if: always()
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              \"text\": \"ðŸš€ Staging Deployment Complete\",
              \"blocks\": [
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \"*Staging Deployment Status*\\n*Repository:* ${{ github.repository }}\\n*Branch:* ${{ github.ref_name }}\\n*Status:* ${{ job.status }}\"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK