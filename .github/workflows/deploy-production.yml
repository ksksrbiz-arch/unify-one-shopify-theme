name: Deploy to Production

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version'
        required: true

jobs:
  deploy-production:
    name: Deploy to Shopify Production
    runs-on: ubuntu-latest
    permissions:
      contents: read
      deployments: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run theme validation
        run: npx shopify theme check --fail-level error

      - name: Install Shopify CLI globally
        run: npm install -g @shopify/cli

      - name: Get release version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "push" ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
          else
            VERSION=${{ github.event.inputs.version }}
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Create deployment
        uses: actions/github-script@v7
        id: deployment
        with:
          script: |
            const deployment = await github.rest.repos.createDeployment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.sha,
              environment: 'production',
              auto_merge: false,
              required_contexts: [],
              description: 'Deploy ${{ steps.version.outputs.version }} to production'
            });
            return deployment.data.id;

      - name: Deploy to Production Theme
        id: deploy
        env:
          SHOPIFY_CLI_THEME_TOKEN: ${{ secrets.SHOPIFY_THEME_TOKEN }}
          SHOPIFY_STORE: 1commerce.shop
          SHOPIFY_PRODUCTION_THEME_ID: ${{ secrets.SHOPIFY_PRODUCTION_THEME_ID }}
        run: |
          echo "Deploying version: ${{ steps.version.outputs.version }}"
          shopify theme push \
            --to "$SHOPIFY_PRODUCTION_THEME_ID" \
            --store "$SHOPIFY_STORE" \
            --allow-live \
            --force
          echo "status=success" >> $GITHUB_OUTPUT

      - name: Verify deployment health
        id: verify
        run: |
          echo "Waiting for deployment to propagate..."
          sleep 30
          
          echo "Verifying production deployment..."
          
          # Check homepage - follow redirects
          HOMEPAGE_STATUS=$(curl -L -s -o /dev/null -w "%{http_code}" https://1commerce.shop/ || echo "000")
          echo "Homepage status: $HOMEPAGE_STATUS"
          
          # Check CSS asset - follow redirects
          CSS_STATUS=$(curl -L -s -o /dev/null -w "%{http_code}" https://1commerce.shop/cdn/shop/t/*/assets/custom-styles.css || echo "000")
          echo "CSS asset status: $CSS_STATUS"
          
          # Check JS asset - follow redirects
          JS_STATUS=$(curl -L -s -o /dev/null -w "%{http_code}" https://1commerce.shop/cdn/shop/t/*/assets/theme.js || echo "000")
          echo "JS asset status: $JS_STATUS"
          
          # Verify all checks passed - accept 2xx and 3xx status codes
          if [[ ! "$HOMEPAGE_STATUS" =~ ^[23][0-9][0-9]$ ]] || [[ ! "$CSS_STATUS" =~ ^[23][0-9][0-9]$ ]] || [[ ! "$JS_STATUS" =~ ^[23][0-9][0-9]$ ]]; then
            echo "❌ Deployment verification failed!"
            echo "Homepage: $HOMEPAGE_STATUS, CSS: $CSS_STATUS, JS: $JS_STATUS"
            echo "verification_status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "✅ Deployment verification successful"
          echo "verification_status=success" >> $GITHUB_OUTPUT

      - name: Create release notes
        uses: actions/github-script@v7
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
        with:
          script: |
            const tag = process.env.GITHUB_REF.replace('refs/tags/', '');
            const release = await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: tag,
              name: `UnifyOne Theme ${tag}`,
              body: `Production deployment of theme version ${tag}`,
              draft: false,
              prerelease: false
            });

      - name: Update deployment status - Success
        if: steps.deploy.outputs.status == 'success'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: ${{ steps.deployment.outputs.result }},
              state: 'success',
              environment_url: 'https://1commerce.shop',
              description: 'Successfully deployed to production',
              auto_inactive: false
            });

      - name: Update deployment status - Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: ${{ steps.deployment.outputs.result }},
              state: 'failure',
              description: 'Failed to deploy to production'
            });

      - name: Slack notification
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: 'UnifyOne Production Deployment - Version: ${{ steps.version.outputs.version }}'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        continue-on-error: true

      - name: Post deployment announcement
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.repos.createDispatchEvent({
              owner: context.repo.owner,
              repo: context.repo.repo,
              event_type: 'deployment-complete',
              client_payload: {
                version: '${{ steps.version.outputs.version }}',
                status: '${{ job.status }}',
                environment: 'production'
              }
            });
