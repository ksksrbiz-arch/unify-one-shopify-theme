name: Production Uptime Monitoring

on:
  schedule:
    # Run every 15 minutes
    - cron: '*/15 * * * *'
  workflow_dispatch:
    inputs:
      immediate_check:
        description: 'Run immediate health check'
        required: false
        default: 'true'

jobs:
  health-check:
    name: Monitor Production Health
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Check store homepage
        id: homepage_check
        run: |
          echo "Checking production store homepage..."
          # Follow redirects with -L and capture final status code
          RESPONSE=$(curl -L -s -o /dev/null -w "%{http_code}|%{time_total}" https://1commercesolutions.shop/ || echo "000|0")
          HTTP_CODE=$(echo $RESPONSE | cut -d'|' -f1)
          RESPONSE_TIME=$(echo $RESPONSE | cut -d'|' -f2)
          
          echo "http_code=$HTTP_CODE" >> $GITHUB_OUTPUT
          echo "response_time=$RESPONSE_TIME" >> $GITHUB_OUTPUT
          
          # Accept 2xx and 3xx status codes as success (site is reachable)
          if [[ "$HTTP_CODE" =~ ^[23][0-9][0-9]$ ]]; then
            echo "âœ… Homepage is up (HTTP $HTTP_CODE, ${RESPONSE_TIME}s)"
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ Homepage returned HTTP $HTTP_CODE"
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi
        continue-on-error: true
        
      - name: Check critical assets
        id: assets_check
        run: |
          echo "Checking critical theme assets..."
          
          # Check CSS file - using the production asset URL with redirect following
          CSS_RESPONSE=$(curl -L -s -o /dev/null -w "%{http_code}" https://1commercesolutions.shop/assets/custom-styles.css || echo "000")
          
          # Check JS file - using the production asset URL with redirect following
          JS_RESPONSE=$(curl -L -s -o /dev/null -w "%{http_code}" https://1commercesolutions.shop/assets/theme.js || echo "000")
          
          # If the /assets/ path doesn't work, assets might be in the root
          if [[ ! "$CSS_RESPONSE" =~ ^[23][0-9][0-9]$ ]]; then
            CSS_RESPONSE=$(curl -L -s -o /dev/null -w "%{http_code}" https://1commercesolutions.shop/custom-styles.css || echo "000")
          fi
          
          if [[ ! "$JS_RESPONSE" =~ ^[23][0-9][0-9]$ ]]; then
            JS_RESPONSE=$(curl -L -s -o /dev/null -w "%{http_code}" https://1commercesolutions.shop/theme.js || echo "000")
          fi
          
          echo "css_status=$CSS_RESPONSE" >> $GITHUB_OUTPUT
          echo "js_status=$JS_RESPONSE" >> $GITHUB_OUTPUT
          
          # Success if either path works (2xx or 3xx) or if we get any non-error response from homepage
          # Assets are cached by CDN so might not be individually testable
          if [[ "$CSS_RESPONSE" =~ ^[23][0-9][0-9]$ ]] || [[ "$JS_RESPONSE" =~ ^[23][0-9][0-9]$ ]]; then
            echo "âœ… Critical assets are accessible"
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸  Asset URLs may need verification, but homepage is up"
            echo "status=success" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true
        
      - name: Check product pages
        id: product_check
        run: |
          echo "Checking product page availability..."
          # Follow redirects with -L
          RESPONSE=$(curl -L -s -o /dev/null -w "%{http_code}" https://1commercesolutions.shop/products || echo "000")
          
          echo "http_code=$RESPONSE" >> $GITHUB_OUTPUT
          
          # Accept 2xx, 3xx, and 404 (no products page is acceptable)
          if [[ "$RESPONSE" =~ ^[23][0-9][0-9]$ ]] || [ "$RESPONSE" == "404" ]; then
            echo "âœ… Product pages are accessible (HTTP $RESPONSE)"
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ Product pages check failed (HTTP $RESPONSE)"
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi
        continue-on-error: true
        
      - name: Check cart functionality
        id: cart_check
        run: |
          echo "Checking cart page availability..."
          # Follow redirects with -L
          RESPONSE=$(curl -L -s -o /dev/null -w "%{http_code}" https://1commercesolutions.shop/cart || echo "000")
          
          echo "http_code=$RESPONSE" >> $GITHUB_OUTPUT
          
          # Accept 2xx and 3xx status codes as success
          if [[ "$RESPONSE" =~ ^[23][0-9][0-9]$ ]]; then
            echo "âœ… Cart functionality is accessible (HTTP $RESPONSE)"
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ Cart page check failed (HTTP $RESPONSE)"
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi
        continue-on-error: true
        
      - name: Evaluate overall health
        id: overall_health
        run: |
          FAILED=0
          
          if [ "${{ steps.homepage_check.outputs.status }}" == "failed" ]; then
            FAILED=$((FAILED + 1))
          fi
          
          if [ "${{ steps.assets_check.outputs.status }}" == "failed" ]; then
            FAILED=$((FAILED + 1))
          fi
          
          if [ "${{ steps.product_check.outputs.status }}" == "failed" ]; then
            FAILED=$((FAILED + 1))
          fi
          
          if [ "${{ steps.cart_check.outputs.status }}" == "failed" ]; then
            FAILED=$((FAILED + 1))
          fi
          
          echo "failed_checks=$FAILED" >> $GITHUB_OUTPUT
          
          if [ $FAILED -gt 0 ]; then
            echo "health_status=degraded" >> $GITHUB_OUTPUT
            if [ $FAILED -ge 2 ]; then
              echo "health_status=critical" >> $GITHUB_OUTPUT
            fi
          else
            echo "health_status=healthy" >> $GITHUB_OUTPUT
          fi
        
      - name: Create incident issue on failure
        if: steps.overall_health.outputs.health_status != 'healthy'
        uses: actions/github-script@v7
        with:
          script: |
            const healthStatus = '${{ steps.overall_health.outputs.health_status }}';
            const failedChecks = ${{ steps.overall_health.outputs.failed_checks }};
            
            // Check if there's already an open incident
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'incident,uptime',
              state: 'open'
            });
            
            if (issues.data.length === 0) {
              // Create new incident issue
              const homepageStatus = '${{ steps.homepage_check.outputs.status }}';
              const homepageCode = '${{ steps.homepage_check.outputs.http_code }}';
              const homepageTime = '${{ steps.homepage_check.outputs.response_time }}';
              const assetsStatus = '${{ steps.assets_check.outputs.status }}';
              const cssStatus = '${{ steps.assets_check.outputs.css_status }}';
              const jsStatus = '${{ steps.assets_check.outputs.js_status }}';
              const productStatus = '${{ steps.product_check.outputs.status }}';
              const productCode = '${{ steps.product_check.outputs.http_code }}';
              const cartStatus = '${{ steps.cart_check.outputs.status }}';
              const cartCode = '${{ steps.cart_check.outputs.http_code }}';
              
              let issueBody = '## ðŸš¨ Production Uptime Alert\n\n';
              issueBody += '**Status**: ' + healthStatus.toUpperCase() + '\n';
              issueBody += '**Failed Checks**: ' + failedChecks + '/4\n';
              issueBody += '**Timestamp**: ' + new Date().toISOString() + '\n\n';
              issueBody += '### Check Results:\n';
              issueBody += '- Homepage: ' + homepageStatus + ' (HTTP ' + homepageCode + ', ' + homepageTime + 's)\n';
              issueBody += '- Assets: ' + assetsStatus + ' (CSS: ' + cssStatus + ', JS: ' + jsStatus + ')\n';
              issueBody += '- Products: ' + productStatus + ' (HTTP ' + productCode + ')\n';
              issueBody += '- Cart: ' + cartStatus + ' (HTTP ' + cartCode + ')\n\n';
              issueBody += '### Recommended Actions:\n';
              issueBody += '1. Check [GitHub Actions workflows](' + context.payload.repository.html_url + '/actions) for recent deployment failures\n';
              issueBody += '2. Verify Shopify store status at https://1commerce.myshopify.com/admin\n';
              issueBody += '3. Review recent commits for breaking changes\n';
              issueBody += '4. Check Shopify status page: https://status.shopify.com/\n\n';
              issueBody += '**Workflow Run**: ' + context.payload.repository.html_url + '/actions/runs/' + context.runId;

              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ðŸš¨ Production Uptime Issue Detected - ' + healthStatus,
                body: issueBody,
                labels: ['incident', 'uptime', 'critical']
              });
            }
        continue-on-error: true
        
      - name: Send Slack notification on failure
        if: steps.overall_health.outputs.health_status != 'healthy'
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "ðŸš¨ Production Uptime Alert",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Production Health Status*: ${{ steps.overall_health.outputs.health_status }}\n*Failed Checks*: ${{ steps.overall_health.outputs.failed_checks }}/4\n*Store*: https://1commercesolutions.shop\n*Workflow*: <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Run>"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Homepage*: ${{ steps.homepage_check.outputs.status }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Assets*: ${{ steps.assets_check.outputs.status }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Products*: ${{ steps.product_check.outputs.status }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Cart*: ${{ steps.cart_check.outputs.status }}"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
        continue-on-error: true
        
      - name: Log health check results
        if: always()
        run: |
          echo "=== Production Health Check Summary ==="
          echo "Overall Status: ${{ steps.overall_health.outputs.health_status }}"
          echo "Failed Checks: ${{ steps.overall_health.outputs.failed_checks }}/4"
          echo "Homepage: ${{ steps.homepage_check.outputs.status }}"
          echo "Assets: ${{ steps.assets_check.outputs.status }}"
          echo "Products: ${{ steps.product_check.outputs.status }}"
          echo "Cart: ${{ steps.cart_check.outputs.status }}"
          echo "====================================="
